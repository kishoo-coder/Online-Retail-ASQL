-- clv
-- CLV tells us how much money a customer is likely to spend 
-- during their entire relationship with our business. 
-- We add up all their purchases and divide by how long they've been a customer. 
-- It helps identify our most valuable customers.
SELECT 
    distinct CUSTOMER_ID,
    LAST_VAL,
    FIRST_VAL,
    DIFF, 
    TOTAL_SALES,
    round((TOTAL_SALES / NULLIF(DIFF, 0)),2) as CLV -- Added NULLIF to handle division by zero
    FROM (
    SELECT 
        CUSTOMER_ID,
        LAST_VALUE(TO_DATE(INVOICEDATE,'MM/DD/YYYY HH24:MI')) OVER (PARTITION BY CUSTOMER_ID ORDER BY TO_DATE(INVOICEDATE,'MM/DD/YYYY HH24:MI') RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS LAST_VAL,
        FIRST_VALUE(TO_DATE(INVOICEDATE,'MM/DD/YYYY HH24:MI')) OVER (PARTITION BY CUSTOMER_ID ORDER BY TO_DATE(INVOICEDATE,'MM/DD/YYYY HH24:MI')) AS FIRST_VAL,
        LAST_VALUE(trunc(TO_DATE(INVOICEDATE,'MM/DD/YYYY HH24:MI'))) OVER (PARTITION BY CUSTOMER_ID ORDER BY TO_DATE(INVOICEDATE,'MM/DD/YYYY HH24:MI')RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) -
        FIRST_VALUE(trunc(TO_DATE(INVOICEDATE,'MM/DD/YYYY HH24:MI'))) OVER (PARTITION BY CUSTOMER_ID ORDER BY TO_DATE(INVOICEDATE,'MM/DD/YYYY HH24:MI')) AS DIFF,
        SUM(QUANTITY * PRICE) OVER (PARTITION BY CUSTOMER_ID) AS TOTAL_SALES FROM tableretail)
        order by customer_id;
